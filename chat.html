<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Strategy Assistant | Chat</title>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --accent: #38bdf8;
            --text: #f1f5f9;
            --bot-bubble: #1e293b;
            --user-bubble: #38bdf8;
        }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: var(--bg); color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        .app-shell {
            display: flex; flex-direction: column;
            height: 100vh; width: 100vw;
        }

        /* Header */
        header {
            padding: 15px 20px;
            background: var(--card);
            border-bottom: 1px solid #334155;
            display: flex; align-items: center; gap: 15px;
            flex-shrink: 0;
        }

        .status-indicator {
            width: 12px; height: 12px; background: #22c55e;
            border-radius: 50%; box-shadow: 0 0 10px #22c55e;
        }

        .header-text h1 { font-size: 1.2rem; margin: 0; color: var(--accent); }
        .header-text p { font-size: 0.8rem; margin: 2px 0 0; color: #94a3b8; }

        /* Chat Area */
        #chatContainer {
            flex: 1; padding: 20px;
            overflow-y: auto; display: flex;
            flex-direction: column; gap: 20px;
            background: #0f172a;
        }

        .msg {
            max-width: 85%; padding: 15px 20px;
            border-radius: 15px; line-height: 1.6;
            font-size: 1.05rem; /* Increased font size */
            word-wrap: break-word;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } }

        .bot {
            align-self: flex-start;
            background: var(--card); color: var(--text);
            border: 1px solid #334155;
            border-bottom-left-radius: 2px;
        }

        .user {
            align-self: flex-end;
            background: var(--user-bubble); color: #0f172a;
            font-weight: 500; border-bottom-right-radius: 2px;
        }

        /* Input Area */
        .input-bar {
            padding: 20px; background: var(--card);
            border-top: 1px solid #334155;
            display: flex; gap: 10px; align-items: center;
        }

        input {
            flex: 1; padding: 15px; background: #0f172a;
            border: 1px solid #334155; border-radius: 10px;
            color: white; font-size: 1rem; outline: none;
        }

        input:focus { border-color: var(--accent); }

        button {
            background: var(--accent); color: #0f172a;
            border: none; padding: 15px 20px; border-radius: 10px;
            font-weight: 800; cursor: pointer; transition: 0.2s;
        }

        button:hover { filter: brightness(1.1); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .loading-text { font-size: 0.8rem; color: var(--accent); font-style: italic; padding: 0 20px 10px; display: none; }
    </style>
</head>
<body>

<div class="app-shell">
    <header>
        <div class="status-indicator"></div>
        <div class="header-text">
            <h1 id="title">Risk Assistant</h1>
            <p id="contextLabel">Context: Initializing conversation...</p>
        </div>
    </header>

    <div id="chatContainer">
        <div class="msg bot">
            Hello! I have analyzed the failure points and the roadmap from the previous page. How would you like to start the journey?
        </div>
    </div>

    <div id="loading" class="loading-text">ðŸ“¡ Thinking...</div>

    <div class="input-bar">
        <input type="text" id="userInput" placeholder="Ask about the roadmap..." autocomplete="off">
        <button id="sendBtn">SEND</button>
    </div>
</div>

<script type="module">
    import { GEMINI_API_KEY as CONFIG_KEY } from './config.js';

    // 1. DATA RETRIEVAL (Priority: LocalStorage > config.js)
    const API_KEY = localStorage.getItem('GEMINI_API_KEY') || CONFIG_KEY; 
    const lastAnalysis = JSON.parse(sessionStorage.getItem('lastAnalysis')) || null;
    const roadmap = JSON.parse(sessionStorage.getItem('roadmap')) || [];

    // 2. API SETUP (Using your working test-code endpoint)
    const MODEL_ID = 'gemini-3-flash-preview'; 
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent?key=${API_KEY}`;

    const chatContainer = document.getElementById('chatContainer');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const loading = document.getElementById('loading');
    const contextLabel = document.getElementById('contextLabel');

    // System Check on Load
    window.onload = () => {
        if (lastAnalysis) {
            contextLabel.innerText = `Focus: ${lastAnalysis.goal}`;
        }
        console.log("Chat Ready. Using Key:", API_KEY ? "Found" : "Missing");
    };

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        // Check key one last time before sending
        if (!API_KEY) {
            addMessage("âŒ API Key is missing. Check config.js or localStorage.", 'bot');
            return;
        }

        addMessage(text, 'user');
        userInput.value = '';
        setLoading(true);

        // This prompt matches the logic of your successful test code
        const payload = {
            contents: [{ 
                parts: [{ 
                    text: `SYSTEM: Strategic Mentor. Context: ${JSON.stringify(lastAnalysis)}. Roadmap: ${roadmap.join(' -> ')}. User asked: ${text}` 
                }] 
            }],
            generationConfig: { temperature: 0.7, maxOutputTokens: 800 }
        };

        try {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (data.error) {
                addMessage(`âŒ API Error: ${data.error.message}`, 'bot');
            } else if (data.candidates && data.candidates[0]) {
                const aiText = data.candidates[0].content.parts[0].text;
                addMessage(aiText, 'bot');
            }
        } catch (err) {
            addMessage("âŒ Connection Failed. Check console (F12).", 'bot');
            console.error("Fetch Error:", err);
        } finally {
            setLoading(false);
        }
    }

    // EVENT LISTENERS
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    function addMessage(text, type) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        chatContainer.appendChild(div);
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
    }

    function setLoading(isLoading) {
        sendBtn.disabled = isLoading;
        userInput.disabled = isLoading;
        loading.style.display = isLoading ? 'block' : 'none';
        if (!isLoading) userInput.focus();
    }
</script>
</body>
</html>